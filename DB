create table transaction_category(
    category_num number(10) primary key,
    category_code varchar2(10) unique,  -- null을 허용하여 카테고리가 기타인 경우 null로 처리할 예정.
                                        -- 이미 등록되어 있는 상품에 대하여 해당 카테고리가 삭제될 경우
                                        -- 상품의 카테고리 코드가 null로 바뀌어 기타 카테고리에 포함시키기 위함.
    category_name varchar2(30) not null
);

CREATE TABLE transaction_user (
    user_id         VARCHAR2(20) PRIMARY KEY,
    user_pwd        VARCHAR2(20) NOT NULL,
    user_name       VARCHAR2(30) NOT NULL,
    user_nickname   VARCHAR2(20) NOT NULL,   -- 닉네임 추가
    user_age        NUMBER(3) NOT NULL,
    user_email      VARCHAR2(50) NOT NULL,
    user_phone      VARCHAR2(20) NOT NULL,
    user_zipcode    VARCHAR2(10),         -- 우편번호
    user_addr       VARCHAR2(100),        -- 기본 주소
    user_addr_detail VARCHAR2(100),       -- 상세 주소
    user_regdate    DATE NOT NULL
);

create table transaction_product(
    product_num number(10) primary key,
    category_code varchar2(10) not null,
    product_name varchar2(50) not null,
    product_date date not null,
    product_img varchar2(200),          -- null 값 허용하여 상품 이미지를 등록하지 않을 경우
                                        -- 해당 컬럼이 null 처리 되어 기본 이미지 출력 되도록 할 예정.
    product_des varchar2(1000),          -- 상품 설명 (null 가능).
    user_id varchar2(20) not null,
    sales_price number(10),
    sales_area varchar2(50) not null,   -- 지도 api를 추가하면서 위치정보에 대한 테이블을 추가적으로 생성 시
                                        -- 해당 컬럼을 외래키로 잡고 새로 생성한 위치정보 테이블의 primary key를
                                        -- 참조키로 잡아야 함.
                                        -- 위치 정보 테이블에서 참조키인 컬럼이 모종의 이유로 삭제될 경우
                                        -- 해당 외래키 컬럼은 어떻게 처리할 지 생각해야 함. (판매지역이 null 이 될 수는 없지만
                                        -- 지역에 해당하는 모든 상품 데이터가 삭제되는 것도 말이 안 됨.)
    constraint category_code_fk foreign key(category_code)
        references transaction_category(category_code)
        on delete set null,
    constraint user_id_fk foreign key(user_id)
        references transaction_user(user_id)
        on delete cascade   -- 상품을 등록한 회원의 정보가 삭제될 경우 해당 회원이 등록한 상품도 삭제처리.
);

-- 관리자는 전 프로젝트와 동일하게 로그인 정보를 통해서 제어 권한만 가질 예정.
create table transaction_manager(
    manager_id varchar2(20) primary key,
    manager_pwd varchar2(20) not null
);

alter table transaction_product add product_title varchar2(100) not null;
alter table transaction_product add product_hits number(10) default 0;
alter table transaction_product add product_status varchar2(50) default '판매중';

-- 1. 시퀀스 생성
CREATE SEQUENCE trans_chat_msg_seq START WITH 1 INCREMENT BY 1;

-- 2. 테이블 생성
CREATE TABLE transaction_chat_messages (
    message_id NUMBER PRIMARY KEY,
    from_user VARCHAR2(50) NOT NULL,
    to_user VARCHAR2(50) NOT NULL,
    product_num NUMBER NOT NULL,
    message CLOB NOT NULL,
    sent_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_read NUMBER(1) DEFAULT 0,
    chat_room_num number DEFAULT 0 not null
);

-- 3. 트리거 생성
CREATE OR REPLACE TRIGGER trans_chat_msg_bi
BEFORE INSERT ON transaction_chat_messages
FOR EACH ROW
BEGIN
    IF :NEW.message_id IS NULL THEN
        SELECT trans_chat_msg_seq.NEXTVAL INTO :NEW.message_id FROM dual;
    END IF;
END;
/
ALTER TABLE transaction_chat_messages ADD is_leave NUMBER(1) DEFAULT 0 NOT NULL;


-- 사용앱 SpringToolSuite4, sqldeveloper 끝
